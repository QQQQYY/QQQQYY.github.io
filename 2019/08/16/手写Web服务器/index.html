<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="keywords" content="chuli, Possible'Blog"><meta name="author" content="chuli"><meta name="description" content="手写Web服务器"><meta name="copyright" content="chuli"><title>手写Web服务器 | Possible'Blog</title><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href="/css/index.css?v=1.0.2"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-stun.png?v=1.0.2"><link rel="icon" type="image/png" sizes="16x16" href="http://img.mp.itc.cn/q_mini,c_zoom,w_640/upload/20161221/c495640d0fc24a91b9c95dc0d54b6002_th.jpeg?v=1.0.2"><script>let CONFIG = {
  back2top_animation: true,
  sidebar_offsetTop: '20px'
};
window.CONFIG = CONFIG;</script></head><body><div id="container"><header id="header" style="background-image: url(https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1562160387218&amp;di=85d9f523320d10c37e527f4c152a324f&amp;imgtype=0&amp;src=http%3A%2F%2Fb-ssl.duitang.com%2Fuploads%2Fitem%2F201609%2F11%2F20160911092406_XfB2k.jpeg)"><nav class="header-nav"><div class="header-nav-inner"><div class="header-nav-menu-icon fa fa-bars"></div><div class="header-nav-search"><i class="fa fa-search"></i><span>搜索</span></div><div class="header-nav-menu"><span><a href="/"><i class="fa fa-home"></i>首页</a></span><span><a href="/archives/"><i class="fa fa-folder-open"></i>归档</a></span><span><a href="/categories/"><i class="fa fa-categories"></i>分类</a></span><span><a href="/tags/"><i class="fa fa-tags"></i>标签</a></span><span><a href="/about/"><i class="fa fa-about"></i>关于</a></span></div></div></nav><div class="header-info"><div class="header-info-inner"><div class="site-info-title">Possible'Blog</div><div class="site-info-subtitle">学习使我快乐，不学习浑身难受</div></div></div></header><main id="main"><div class="main-inner"><aside id="sidebar"><div class="sidebar-inner"><div class="sidebar-nav"><span class="sidebar-nav-toc current">文章目录</span><span class="sidebar-nav-overview">站点概览</span></div><section class="sidebar-toc"><div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#手写Web服务器"><span class="toc-number">1.</span> <span class="toc-text">手写Web服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#涉及到的知识点"><span class="toc-number">1.1.</span> <span class="toc-text">涉及到的知识点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WebServer简介"><span class="toc-number">1.2.</span> <span class="toc-text">WebServer简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#反射"><span class="toc-number">1.3.</span> <span class="toc-text">反射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#XML解析"><span class="toc-number">1.4.</span> <span class="toc-text">XML解析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#html"><span class="toc-number">1.5.</span> <span class="toc-text">html</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP协议"><span class="toc-number">1.6.</span> <span class="toc-text">HTTP协议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#手写服务器"><span class="toc-number">1.7.</span> <span class="toc-text">手写服务器</span></a></li></ol></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#内容到这里暂时就结束了"><span class="toc-number"></span> <span class="toc-text">内容到这里暂时就结束了</span></a></li></div></section><section class="hide sidebar-overview"><div class="sidebar-author"><img class="sidebar-author-avatar" src="http://img.mp.itc.cn/q_mini,c_zoom,w_640/upload/20161221/c495640d0fc24a91b9c95dc0d54b6002_th.jpeg" alt="avatar"></div><div class="sidebar-state"><div class="sidebar-state-item sidebar-state-posts"><a href="/archives/"><div class="sidebar-state-item-count">23</div><div class="sidebar-state-item-name">文章</div></a></div><div class="sidebar-state-item sidebar-state-categories"><a href="/categories/"><div class="sidebar-state-item-count">1</div><div class="sidebar-state-item-name">分类</div></a></div><div class="sidebar-state-item sidebar-state-tags"><a href="/tags/"><div class="sidebar-state-item-count">5</div><div class="sidebar-state-item-name">标签</div></a></div></div><div class="sidebar-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="creative commons"></a></div></section><div class="sidebar-progress"><div class="sidebar-progress-read"><span>你已阅读了</span><span class="sidebar-progress-number"></span></div><div class="sidebar-progress-line"></div></div></div></aside><div class="main-content code-highlight"><div class="post-header"><h1 class="post-title">手写Web服务器</h1><div class="post-meta"><span class="post-meta-create"><i class="fa fa-calendar-o"></i><span>发表于 </span><span>2019-08-16</span></span><span class="post-meta-update"><i class="fa fa-calendar-check-o"></i><span>更新于 </span><span>2019-08-25</span></span><span class="post-meta-reading-count"><i class="fa fa-eye"></i><span>阅读次数 </span><span id="busuanzi_value_page_pv"></span></span></div></div><div class="post-body"><h2 id="手写Web服务器"><a href="#手写Web服务器" class="headerlink" title="手写Web服务器"></a>手写Web服务器</h2><h3 id="涉及到的知识点"><a href="#涉及到的知识点" class="headerlink" title="涉及到的知识点"></a>涉及到的知识点</h3><p>OOP、容器、IO流、多线程、网络编程、XML解析、反射、html、http</p>
<h3 id="WebServer简介"><a href="#WebServer简介" class="headerlink" title="WebServer简介"></a>WebServer简介</h3><blockquote>
<ul>
<li>上网浏览网页，离不开服务器，客户请求页面，服务器响应内容。都是基于HTTP协议。</li>
<li>Web请求都是使用Request和Response式的交流</li>
</ul>
</blockquote>
<h3 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h3><p>反射Reflection：把Java类中的各种结构方法、属性、构造器、类名映射成一个个Java对象。利用反射技术可以对一个类进行解剖，反射是框架设计的灵魂。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> zhuchuli.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 朱楚利</span></span><br><span class="line"><span class="comment"> *反射：把Java类中的结构方法，属性，类名，构造器映射成一个个Java对象</span></span><br><span class="line"><span class="comment"> *1、获取Class对象</span></span><br><span class="line"><span class="comment"> *        三种方式：Class.forName(完整路径);</span></span><br><span class="line"><span class="comment"> *2、可以动态创建对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReflectTest01</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">		<span class="comment">//三种方式</span></span><br><span class="line">		<span class="comment">//1. 对象.getClass()</span></span><br><span class="line">		Class clz=<span class="keyword">new</span> Iphone().getClass();</span><br><span class="line">		<span class="comment">//2.类.class</span></span><br><span class="line">		clz=Iphone.class;</span><br><span class="line">		<span class="comment">//3.定位 Class.forName("包名.类名");</span></span><br><span class="line">		clz=Class.forName(<span class="string">"zhuchuli.server.Iphone"</span>);</span><br><span class="line">		<span class="comment">//JDK9.0提供的创建对象的方法</span></span><br><span class="line">		Iphone iphone=(Iphone)clz.getConstructor().newInstance();</span><br><span class="line">		System.out.println(iphone);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Iphone</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Iphone</span><span class="params">()</span> </span>&#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="XML解析"><a href="#XML解析" class="headerlink" title="XML解析"></a>XML解析</h3><blockquote>
<ul>
<li>解析流程（按流的方式进行解析）<blockquote>
<ul>
<li>获取解析工程：<code>SAXParserFactory factory = SAXParserFactory.newInstance()</code>;</li>
<li>获取解析器：<code>SAXParser parser = factory.newSAXParser();</code></li>
<li>编写处理器，加载文档document注册处理器：<code>PHandler handler = new PHandler();</code></li>
<li>解析：<code>parser.parse(Thread.currentThread().getContextClassLoader().getResourceAsStream(&quot;zhuchuli/server/p.xml&quot;), handler);</code></li>
</ul>
</blockquote>
</li>
</ul>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> zhuchuli.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.SAXParser;</span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.SAXParserFactory;</span><br><span class="line"><span class="keyword">import</span> org.xml.sax.Attributes;</span><br><span class="line"><span class="keyword">import</span> org.xml.sax.SAXException;</span><br><span class="line"><span class="keyword">import</span> org.xml.sax.helpers.DefaultHandler;</span><br><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 熟悉SAX解析流程</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 朱楚利</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XMLTest01</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="comment">//SAX解析</span></span><br><span class="line">		<span class="comment">//1.获取解析工厂</span></span><br><span class="line">		SAXParserFactory factory = SAXParserFactory.newInstance();</span><br><span class="line">		<span class="comment">//2.从解析工厂获取解析器</span></span><br><span class="line">		SAXParser parser = factory.newSAXParser();</span><br><span class="line">		<span class="comment">//3.编写处理器</span></span><br><span class="line">		<span class="comment">//4.加载文档document注册处理器</span></span><br><span class="line">        PHandler handler = <span class="keyword">new</span> PHandler();</span><br><span class="line">        <span class="comment">//5、解析</span></span><br><span class="line">        parser.parse(Thread.currentThread().getContextClassLoader().getResourceAsStream(<span class="string">"zhuchuli/server/p.xml"</span>), handler);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PHandler</span> <span class="keyword">extends</span> <span class="title">DefaultHandler</span></span>&#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startDocument</span><span class="params">()</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"************** 解析文档开始 ******************"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//解析元素 标签</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startElement</span><span class="params">(String uri, String localName, String qName, Attributes attributes)</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line">		System.out.println(qName+<span class="string">"------&gt;"</span>+<span class="string">"解析开始"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//标签内容</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">characters</span><span class="params">(<span class="keyword">char</span>[] ch, <span class="keyword">int</span> start, <span class="keyword">int</span> length)</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line">		<span class="comment">//trim()方法 去掉前后空格</span></span><br><span class="line">		String contents=<span class="keyword">new</span> String(ch,start,length).trim();</span><br><span class="line">		<span class="keyword">if</span>(contents.equals(<span class="string">""</span>)) &#123;</span><br><span class="line">			System.out.println(<span class="string">"内容为 ---&gt;"</span>+<span class="string">"空"</span>);</span><br><span class="line">		&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">			System.out.println(<span class="string">"内容为 ---&gt;"</span>+contents);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endElement</span><span class="params">(String uri, String localName, String qName)</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line">		System.out.println(qName+<span class="string">"------&gt;"</span>+<span class="string">"解析结束"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endDocument</span><span class="params">()</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"**************解析文档结束******************"</span>);</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="html"><a href="#html" class="headerlink" title="html"></a>html</h3><p>html：HyperText Markup Language：超文本标记语言，简单理解为浏览器使用的语言。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">title</span>&gt;</span>第一个html页面<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">h1</span>&gt;</span>表单的使用<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">pre</span>&gt;</span></span><br><span class="line">		name： web服务器使用的属性<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">		id： 前端js使用的属性<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">		action：请求web服务器的资源 <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">		method： get/post<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">		get：从服务器端获取数据，默认发送行为，发送数据量不宜较大，不安全，请求参数跟在url上<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">		post：向服务器端发送数据，发送数据量相对较大，安全，请求参数在请求体中</span><br><span class="line">	<span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">action</span>=<span class="string">"https://localhost:8888/index.html"</span>&gt;</span></span><br><span class="line">		用户名：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"uname"</span> <span class="attr">id</span>=<span class="string">"uname"</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">		密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"pswd"</span> <span class="attr">id</span>=<span class="string">"pswd"</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"提交"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="HTTP协议"><a href="#HTTP协议" class="headerlink" title="HTTP协议"></a>HTTP协议</h3><p>超文本传输协议（HTTP，HyperText Transfer Protocol）是互联网上应用最为广泛的一种网络协议，所以的WWW文件都必须遵守这个标准。</p>
<blockquote>
<ul>
<li>请求协议<blockquote>
<ul>
<li>请求行：方法（GET/POST） URI 协议/版本；</li>
<li>请求头：（Request Header）</li>
<li>请求正文：</li>
</ul>
</blockquote>
</li>
<li>响应协议<blockquote>
<ul>
<li>状态行：协议/版本 状态码 描述</li>
<li>响应头：（Response Header）</li>
<li>响应正文：                                </li>
</ul>
</blockquote>
</li>
</ul>
</blockquote>
<h3 id="手写服务器"><a href="#手写服务器" class="headerlink" title="手写服务器"></a>手写服务器</h3><blockquote>
<ul>
<li>获取请求协议<blockquote>
<ul>
<li>创建ServerSocket</li>
<li>建立连接获取Socket</li>
<li>通过输入流获取请求协议</li>
<li>注意：GET和POST不一致的地方</li>
</ul>
</blockquote>
</li>
</ul>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhuchuli.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.ServerSocket;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 目标：使用ServerSocket建立与浏览器的连接，获取请求协议</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 朱楚利</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server01</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> ServerSocket serverSocket;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		Server01 server=<span class="keyword">new</span> Server01();</span><br><span class="line">		server.start(); </span><br><span class="line">		server.receive();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//启动服务</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			serverSocket=<span class="keyword">new</span> ServerSocket(<span class="number">8888</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			System.out.println(<span class="string">"服务器启动失败..."</span>);</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//接收连接处理</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Socket client = serverSocket.accept();</span><br><span class="line">			System.out.println(<span class="string">"一个客户端建立了连接...."</span>);</span><br><span class="line">			<span class="comment">//获取请求协议</span></span><br><span class="line">			InputStream is=client.getInputStream();</span><br><span class="line">			<span class="keyword">byte</span>[] datas=<span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>*<span class="number">1024</span>];</span><br><span class="line">			<span class="keyword">int</span> len=is.read(datas);</span><br><span class="line">			String requestInfo = <span class="keyword">new</span> String(datas,<span class="number">0</span>,len);</span><br><span class="line">			System.out.println(requestInfo);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			System.out.println(<span class="string">"客户端连接出现错误..."</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//停止服务</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>返回响应协议<blockquote>
<ul>
<li>准备内容。</li>
<li>获取字节数的长度。</li>
<li>拼接响应协议。<blockquote>
<ul>
<li>注意：空格与换行。</li>
</ul>
</blockquote>
</li>
<li>使用输出流输出。</li>
</ul>
</blockquote>
</li>
</ul>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhuchuli.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStreamWriter;</span><br><span class="line"><span class="keyword">import</span> java.net.ServerSocket;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 目标：返回响应协议</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 朱楚利</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server02</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> ServerSocket serverSocket;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		Server02 server=<span class="keyword">new</span> Server02();</span><br><span class="line">		server.start(); </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//启动服务</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			serverSocket=<span class="keyword">new</span> ServerSocket(<span class="number">8888</span>);</span><br><span class="line">			receive();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			System.out.println(<span class="string">"服务器启动失败..."</span>);</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//接收连接处理</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Socket client = serverSocket.accept();</span><br><span class="line">			System.out.println(<span class="string">"一个客户端建立了连接...."</span>);</span><br><span class="line">			<span class="comment">//获取请求协议</span></span><br><span class="line">			InputStream is=client.getInputStream();</span><br><span class="line">			<span class="keyword">byte</span>[] datas=<span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>*<span class="number">1024</span>];</span><br><span class="line">			<span class="keyword">int</span> len=is.read(datas);</span><br><span class="line">			String requestInfo = <span class="keyword">new</span> String(datas,<span class="number">0</span>,len);</span><br><span class="line">			System.out.println(requestInfo);</span><br><span class="line">			<span class="comment">//返回响应协议</span></span><br><span class="line">			StringBuilder content=<span class="keyword">new</span> StringBuilder();</span><br><span class="line">			content.append(<span class="string">"&lt;html&gt;"</span>);</span><br><span class="line">			content.append(<span class="string">"&lt;head&gt;"</span>);</span><br><span class="line">			content.append(<span class="string">"&lt;title&gt;"</span>);</span><br><span class="line">			content.append(<span class="string">"服务器响应成功"</span>);</span><br><span class="line">			content.append(<span class="string">"&lt;/title&gt;"</span>);</span><br><span class="line">			content.append(<span class="string">"&lt;/head&gt;"</span>);</span><br><span class="line">			content.append(<span class="string">"&lt;body&gt;"</span>);</span><br><span class="line">			content.append(<span class="string">"zhuchuli Server回来了..."</span>);</span><br><span class="line">			content.append(<span class="string">"&lt;/body&gt;"</span>);</span><br><span class="line">			content.append(<span class="string">"&lt;/html&gt;"</span>);</span><br><span class="line">			<span class="comment">//字节长度</span></span><br><span class="line">			<span class="keyword">int</span> size= content.toString().getBytes().length;<span class="comment">//必须获取字节的长度</span></span><br><span class="line">			StringBuilder responseInfo=<span class="keyword">new</span> StringBuilder();</span><br><span class="line">			String blank=<span class="string">" "</span>;<span class="comment">//空格</span></span><br><span class="line">			String CRLF=<span class="string">"\r\n"</span>;<span class="comment">//换行符</span></span><br><span class="line">			<span class="comment">//1.响应行 Http/1.1 200 OK</span></span><br><span class="line">			responseInfo.append(<span class="string">"HTTP/1.1"</span>).append(blank);</span><br><span class="line">			responseInfo.append(<span class="number">200</span>).append(blank);</span><br><span class="line">			responseInfo.append(<span class="string">"OK"</span>).append(CRLF);</span><br><span class="line">			<span class="comment">//2.响应头：（最后一行存在空行）</span></span><br><span class="line">			<span class="comment">/* Date:Mon,31 Dec208804:36:57GMT</span></span><br><span class="line"><span class="comment">			 * Server:zhuchuli Server/0.0.1;charset=GBK</span></span><br><span class="line"><span class="comment">			 * Content-Type:text/html</span></span><br><span class="line"><span class="comment">			 * Content-Length:39725426</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			responseInfo.append(<span class="string">"Date:"</span>).append(<span class="keyword">new</span> Date()).append(CRLF);</span><br><span class="line">			responseInfo.append(<span class="string">"Server:"</span>).append(<span class="string">"zhuchuli Server/0.0.1;charset=GBK"</span>).append(CRLF);</span><br><span class="line">			responseInfo.append(<span class="string">"Content-Type:text/html"</span>).append(CRLF);</span><br><span class="line">			responseInfo.append(<span class="string">"Content-Length:"</span>).append(size).append(CRLF);</span><br><span class="line">			responseInfo.append(CRLF);</span><br><span class="line">			<span class="comment">//3.正文 </span></span><br><span class="line">			responseInfo.append(content.toString());</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//写出到客户端</span></span><br><span class="line">			BufferedWriter bw=<span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> OutputStreamWriter(client.getOutputStream(),<span class="string">"UTF-8"</span>));</span><br><span class="line">			bw.write(responseInfo.toString());</span><br><span class="line">			bw.flush();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			System.out.println(<span class="string">"客户端连接出现错误..."</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//停止服务</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>封装响应信息<blockquote>
<ul>
<li>动态添加内容print；</li>
<li>累加字节数的长度；</li>
<li>根据状态码拼接响应头协议；</li>
<li>根据状态码同意推送出去；</li>
<li>调用处：动态调用print + 传入状态码推送。</li>
</ul>
</blockquote>
</li>
</ul>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhuchuli.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStreamWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Response</span> </span>&#123;</span><br><span class="line">	<span class="comment">//缓存输出流</span></span><br><span class="line">	<span class="keyword">private</span> BufferedWriter bw;</span><br><span class="line">	<span class="comment">//正文</span></span><br><span class="line">	<span class="keyword">private</span> StringBuilder content;</span><br><span class="line">	<span class="comment">//协议头（状态行与响应头 回车与空格）信息</span></span><br><span class="line">	<span class="keyword">private</span> StringBuilder headInfo;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String BLANK=<span class="string">" "</span>;<span class="comment">//空格</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String CRLF=<span class="string">"\r\n"</span>;<span class="comment">//换行符</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> len;<span class="comment">//正文的字节数</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="title">Response</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		content=<span class="keyword">new</span> StringBuilder();</span><br><span class="line">		headInfo=<span class="keyword">new</span> StringBuilder();</span><br><span class="line">		len=<span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Response</span><span class="params">(Socket client)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			bw=<span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> OutputStreamWriter(client.getOutputStream(),<span class="string">"UTF-8"</span>));</span><br><span class="line">		&#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">			<span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">			e.printStackTrace();</span><br><span class="line">			headInfo=<span class="keyword">null</span>;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			<span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">			e.printStackTrace();</span><br><span class="line">			headInfo=<span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Response</span><span class="params">(OutputStream os)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>();</span><br><span class="line">		bw=<span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> OutputStreamWriter(os));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//动态添加内容</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Response <span class="title">print</span><span class="params">(String info)</span> </span>&#123;</span><br><span class="line">		content.append(info);</span><br><span class="line">		len+=info.getBytes().length;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;<span class="comment">//流模式 返回自身</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Response <span class="title">println</span><span class="params">(String info)</span> </span>&#123;</span><br><span class="line">		content.append(info).append(CRLF);</span><br><span class="line">		len+=(info+CRLF).getBytes().length;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;<span class="comment">//流模式 返回自身</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//推送响应信息</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pushToBrower</span><span class="params">(<span class="keyword">int</span> code)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">null</span> == headInfo) &#123;</span><br><span class="line">			code=<span class="number">505</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		createHeadInfo(code);</span><br><span class="line">		bw.append(headInfo);</span><br><span class="line">		bw.append(content);</span><br><span class="line">		bw.flush();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//构建头信息</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createHeadInfo</span><span class="params">(<span class="keyword">int</span> code)</span> </span>&#123;</span><br><span class="line">		<span class="comment">//1.响应行 Http/1.1 200 OK</span></span><br><span class="line">		headInfo.append(<span class="string">"HTTP/1.1"</span>).append(BLANK);</span><br><span class="line">		headInfo.append(code).append(BLANK);</span><br><span class="line">		<span class="keyword">switch</span>(code) &#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">200</span>: headInfo.append(<span class="string">"OK"</span>).append(CRLF);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">404</span>: headInfo.append(<span class="string">"NOT FOUND"</span>).append(CRLF);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">505</span>: headInfo.append(<span class="string">"SERVER ERROR"</span>).append(CRLF);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//2.响应头：（最后一行存在空行）</span></span><br><span class="line">		<span class="comment">/* Date:Mon,31 Dec208804:36:57GMT</span></span><br><span class="line"><span class="comment">		 * Server:zhuchuli Server/0.0.1;charset=GBK</span></span><br><span class="line"><span class="comment">		 * Content-Type:text/html</span></span><br><span class="line"><span class="comment">		 * Content-Length:39725426</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		headInfo.append(<span class="string">"Date:"</span>).append(<span class="keyword">new</span> Date()).append(CRLF);</span><br><span class="line">		headInfo.append(<span class="string">"Server:"</span>).append(<span class="string">"zhuchuli Server/0.0.1;charset=GBK"</span>).append(CRLF);</span><br><span class="line">		headInfo.append(<span class="string">"Content-Type:text/html"</span>).append(CRLF);</span><br><span class="line">		headInfo.append(<span class="string">"Content-Length:"</span>).append(len).append(CRLF);</span><br><span class="line">		headInfo.append(CRLF);</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhuchuli.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStreamWriter;</span><br><span class="line"><span class="keyword">import</span> java.net.ServerSocket;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 目标：封装响应信息</span></span><br><span class="line"><span class="comment"> * 1、内容可以动态添加。</span></span><br><span class="line"><span class="comment"> * 2、只关注状态码，拼接好响应信息。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 朱楚利</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server03</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> ServerSocket serverSocket;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		Server03 server=<span class="keyword">new</span> Server03();</span><br><span class="line">		server.start(); </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//启动服务</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			serverSocket=<span class="keyword">new</span> ServerSocket(<span class="number">8888</span>);</span><br><span class="line">			receive();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			System.out.println(<span class="string">"服务器启动失败..."</span>);</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//接收连接处理</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Socket client = serverSocket.accept();</span><br><span class="line">			System.out.println(<span class="string">"一个客户端建立了连接...."</span>);</span><br><span class="line">			<span class="comment">//获取请求协议</span></span><br><span class="line">			InputStream is=client.getInputStream();</span><br><span class="line">			<span class="keyword">byte</span>[] datas=<span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>*<span class="number">1024</span>];</span><br><span class="line">			<span class="keyword">int</span> len=is.read(datas);</span><br><span class="line">			String requestInfo = <span class="keyword">new</span> String(datas,<span class="number">0</span>,len);</span><br><span class="line">			System.out.println(requestInfo);</span><br><span class="line">			</span><br><span class="line">			Response response=<span class="keyword">new</span> Response(client);</span><br><span class="line">			<span class="comment">//只关注了内容</span></span><br><span class="line">			response.print(<span class="string">"&lt;html&gt;"</span>);</span><br><span class="line">			response.print(<span class="string">"&lt;head&gt;"</span>);</span><br><span class="line">			response.print(<span class="string">"&lt;title&gt;"</span>);</span><br><span class="line">			response.print(<span class="string">"服务器响应成功"</span>);</span><br><span class="line">			response.print(<span class="string">"&lt;/title&gt;"</span>);</span><br><span class="line">			response.print(<span class="string">"&lt;/head&gt;"</span>);</span><br><span class="line">			response.print(<span class="string">"&lt;body&gt;"</span>);</span><br><span class="line">			response.print(<span class="string">"zhuchuli Server回来了..."</span>);</span><br><span class="line">			response.print(<span class="string">"&lt;/body&gt;"</span>);</span><br><span class="line">			response.print(<span class="string">"&lt;/html&gt;"</span>);</span><br><span class="line">		</span><br><span class="line">			<span class="comment">//只关注了状态码</span></span><br><span class="line">			response.pushToBrower(<span class="number">200</span>);</span><br><span class="line">			</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			System.out.println(<span class="string">"客户端连接出现错误..."</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//停止服务</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>封装请求信息<blockquote>
<ul>
<li>通过分解字符串获取method、url和请求参数 <code>Post</code>请求参数可能在请求体中存在。</li>
</ul>
</blockquote>
</li>
</ul>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhuchuli.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 封装请求协议：获取method、URI以及请求参数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 朱楚利</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Request</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String requestInfo;<span class="comment">//协议信息</span></span><br><span class="line">	<span class="keyword">private</span> String method;<span class="comment">//请求方式</span></span><br><span class="line">	<span class="keyword">private</span> String url;<span class="comment">//请求的url</span></span><br><span class="line">	<span class="keyword">private</span> String queryStr;<span class="comment">//请求参数</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String CRLF=<span class="string">"\r\n"</span>;<span class="comment">//换行符</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Request</span><span class="params">(Socket client)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>(client.getInputStream());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Request</span><span class="params">(InputStream is)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">byte</span>[] datas=<span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>*<span class="number">1024</span>];</span><br><span class="line">		<span class="keyword">int</span> len;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			len = is.read(datas);</span><br><span class="line">			<span class="keyword">this</span>.requestInfo = <span class="keyword">new</span> String(datas,<span class="number">0</span>,len);</span><br><span class="line">			System.out.println(requestInfo);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//分解字符串</span></span><br><span class="line">		parseRequestInfo();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseRequestInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"-------分解---------"</span>);</span><br><span class="line">		System.out.println(<span class="string">"------1、获取请求方式：开头到第一个/----------"</span>);</span><br><span class="line">		<span class="keyword">this</span>.method=<span class="keyword">this</span>.requestInfo.substring(<span class="number">0</span>, <span class="keyword">this</span>.requestInfo.indexOf(<span class="string">"/"</span>)-<span class="number">1</span>).toLowerCase();</span><br><span class="line">		System.out.println(<span class="string">"------2、获取请求URL：第一个/到HTTP/----------"</span>);</span><br><span class="line">		System.out.println(<span class="string">"---------可能包含请求参+数?前面的为url------------"</span>);</span><br><span class="line">		<span class="comment">//1)获取第一个/位置</span></span><br><span class="line">		<span class="keyword">int</span> startIdx=<span class="keyword">this</span>.requestInfo.indexOf(<span class="string">"/"</span>)+<span class="number">1</span>;</span><br><span class="line">		<span class="comment">//2)获取第一个/HTTP/位置</span></span><br><span class="line">		<span class="keyword">int</span> endIdx=<span class="keyword">this</span>.requestInfo.indexOf(<span class="string">"HTTP/"</span>);</span><br><span class="line">		<span class="comment">//3)分割字符串</span></span><br><span class="line">		<span class="keyword">this</span>.url=<span class="keyword">this</span>.requestInfo.substring(startIdx,endIdx);</span><br><span class="line">		<span class="comment">//4)获取问号的位置 </span></span><br><span class="line">		<span class="keyword">int</span> queryIdx=<span class="keyword">this</span>.url.indexOf(<span class="string">"?"</span>);</span><br><span class="line">		<span class="keyword">if</span>(queryIdx &gt;= <span class="number">0</span>) &#123;<span class="comment">//表示带有参数</span></span><br><span class="line">			String[] urlArray=<span class="keyword">this</span>.url.split(<span class="string">"\\?"</span>);</span><br><span class="line">			<span class="keyword">this</span>.url=urlArray[<span class="number">0</span>];</span><br><span class="line">			<span class="keyword">this</span>.queryStr=urlArray[<span class="number">1</span>].trim();<span class="comment">//请求参数</span></span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println(<span class="string">"------3、获取请求URL后面的请求参数GET已经获取，如果是Post可能在请求体中----------"</span>);</span><br><span class="line">		<span class="keyword">if</span>(method.equals(<span class="string">"post"</span>)) &#123;</span><br><span class="line">			</span><br><span class="line">			String qStr= <span class="keyword">this</span>.requestInfo.substring(<span class="keyword">this</span>.requestInfo.lastIndexOf(CRLF)).trim();</span><br><span class="line">			<span class="keyword">if</span>(<span class="keyword">null</span>== queryStr) &#123;</span><br><span class="line">				queryStr=qStr;</span><br><span class="line">			&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">				queryStr += <span class="string">"&amp;"</span>+qStr;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		queryStr = <span class="keyword">null</span> == queryStr?<span class="string">""</span>:queryStr;</span><br><span class="line">		System.out.println(method+<span class="string">"----&gt;"</span>+url+<span class="string">"----&gt;"</span>+<span class="keyword">this</span>.queryStr);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhuchuli.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStreamWriter;</span><br><span class="line"><span class="keyword">import</span> java.net.ServerSocket;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 目标：封装请求信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 朱楚利</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server04</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> ServerSocket serverSocket;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		Server04 server=<span class="keyword">new</span> Server04();</span><br><span class="line">		server.start(); </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//启动服务</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			serverSocket=<span class="keyword">new</span> ServerSocket(<span class="number">8888</span>);</span><br><span class="line">			receive();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			System.out.println(<span class="string">"服务器启动失败..."</span>);</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//接收连接处理</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Socket client = serverSocket.accept();</span><br><span class="line">			System.out.println(<span class="string">"一个客户端建立了连接...."</span>);</span><br><span class="line">			<span class="comment">//获取请求协议</span></span><br><span class="line">			Request request=<span class="keyword">new</span> Request(client);</span><br><span class="line">			<span class="comment">//获取响应协议</span></span><br><span class="line">			Response response=<span class="keyword">new</span> Response(client);</span><br><span class="line">			<span class="comment">//只关注了内容</span></span><br><span class="line">			response.print(<span class="string">"&lt;html&gt;"</span>);</span><br><span class="line">			response.print(<span class="string">"&lt;head&gt;"</span>);</span><br><span class="line">			response.print(<span class="string">"&lt;title&gt;"</span>);</span><br><span class="line">			response.print(<span class="string">"服务器响应成功"</span>);</span><br><span class="line">			response.print(<span class="string">"&lt;/title&gt;"</span>);</span><br><span class="line">			response.print(<span class="string">"&lt;/head&gt;"</span>);</span><br><span class="line">			response.print(<span class="string">"&lt;body&gt;"</span>);</span><br><span class="line">			response.print(<span class="string">"zhuchuli Server回来了..."</span>);</span><br><span class="line">			response.print(<span class="string">"&lt;/body&gt;"</span>);</span><br><span class="line">			response.print(<span class="string">"&lt;/html&gt;"</span>);</span><br><span class="line">		</span><br><span class="line">			<span class="comment">//只关注了状态码</span></span><br><span class="line">			response.pushToBrower(<span class="number">200</span>);</span><br><span class="line">			</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			System.out.println(<span class="string">"客户端连接出现错误..."</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//停止服务</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>处理请求参数<blockquote>
<ul>
<li>通过Map封装请求参数两个方法：<code>getParameter(String key)</code>，<code>getParameterValues(String key)</code>；</li>
</ul>
</blockquote>
</li>
</ul>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhuchuli.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 封装请求协议：封装请求参数为Map</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 朱楚利</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Request02</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String requestInfo;<span class="comment">//协议信息</span></span><br><span class="line">	<span class="keyword">private</span> String method;<span class="comment">//请求方式</span></span><br><span class="line">	<span class="keyword">private</span> String url;<span class="comment">//请求的url</span></span><br><span class="line">	<span class="keyword">private</span> String queryStr;<span class="comment">//请求参数</span></span><br><span class="line">	<span class="keyword">private</span> Map&lt;String,List&lt;String&gt;&gt; parameterMap;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String CRLF=<span class="string">"\r\n"</span>;<span class="comment">//换行符</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Request02</span><span class="params">(Socket client)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>(client.getInputStream());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Request02</span><span class="params">(InputStream is)</span> </span>&#123;</span><br><span class="line">		parameterMap = <span class="keyword">new</span> HashMap&lt;String, List&lt;String&gt;&gt;();</span><br><span class="line">		<span class="keyword">byte</span>[] datas=<span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>*<span class="number">1024</span>];</span><br><span class="line">		<span class="keyword">int</span> len;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			len = is.read(datas);</span><br><span class="line">			<span class="keyword">this</span>.requestInfo = <span class="keyword">new</span> String(datas,<span class="number">0</span>,len);</span><br><span class="line">			System.out.println(requestInfo);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//分解字符串</span></span><br><span class="line">		parseRequestInfo();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseRequestInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"-------分解---------"</span>);</span><br><span class="line">		System.out.println(<span class="string">"------1、获取请求方式：开头到第一个/----------"</span>);</span><br><span class="line">		<span class="keyword">this</span>.method=<span class="keyword">this</span>.requestInfo.substring(<span class="number">0</span>, <span class="keyword">this</span>.requestInfo.indexOf(<span class="string">"/"</span>)-<span class="number">1</span>).toLowerCase();</span><br><span class="line">		System.out.println(<span class="string">"------2、获取请求URL：第一个/到HTTP/----------"</span>);</span><br><span class="line">		System.out.println(<span class="string">"---------可能包含请求参+数?前面的为url------------"</span>);</span><br><span class="line">		<span class="comment">//1)获取第一个/位置</span></span><br><span class="line">		<span class="keyword">int</span> startIdx=<span class="keyword">this</span>.requestInfo.indexOf(<span class="string">"/"</span>)+<span class="number">1</span>;</span><br><span class="line">		<span class="comment">//2)获取第一个/HTTP/位置</span></span><br><span class="line">		<span class="keyword">int</span> endIdx=<span class="keyword">this</span>.requestInfo.indexOf(<span class="string">"HTTP/"</span>);</span><br><span class="line">		<span class="comment">//3)分割字符串</span></span><br><span class="line">		<span class="keyword">this</span>.url=<span class="keyword">this</span>.requestInfo.substring(startIdx,endIdx);</span><br><span class="line">		<span class="comment">//4)获取问号的位置 </span></span><br><span class="line">		<span class="keyword">int</span> queryIdx=<span class="keyword">this</span>.url.indexOf(<span class="string">"?"</span>);</span><br><span class="line">		<span class="keyword">if</span>(queryIdx &gt;= <span class="number">0</span>) &#123;<span class="comment">//表示带有参数</span></span><br><span class="line">			String[] urlArray=<span class="keyword">this</span>.url.split(<span class="string">"\\?"</span>);</span><br><span class="line">			<span class="keyword">this</span>.url=urlArray[<span class="number">0</span>];</span><br><span class="line">			<span class="keyword">this</span>.queryStr=urlArray[<span class="number">1</span>].trim();<span class="comment">//请求参数</span></span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println(<span class="string">"------3、获取请求URL后面的请求参数GET已经获取，如果是Post可能在请求体中----------"</span>);</span><br><span class="line">		<span class="keyword">if</span>(method.equals(<span class="string">"post"</span>)) &#123;</span><br><span class="line">			</span><br><span class="line">			String qStr= <span class="keyword">this</span>.requestInfo.substring(<span class="keyword">this</span>.requestInfo.lastIndexOf(CRLF)).trim();</span><br><span class="line">			<span class="keyword">if</span>(<span class="keyword">null</span>== queryStr) &#123;</span><br><span class="line">				queryStr=qStr;</span><br><span class="line">			&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">				queryStr += <span class="string">"&amp;"</span>+qStr;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		queryStr = <span class="keyword">null</span> == queryStr?<span class="string">""</span>:queryStr;</span><br><span class="line">		System.out.println(method+<span class="string">"----&gt;"</span>+url+<span class="string">"----&gt;"</span>+<span class="keyword">this</span>.queryStr);</span><br><span class="line">		<span class="comment">//转成Map fav=1,fav=2,uname=sss,age=18 others=</span></span><br><span class="line">		convertMap();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//处理请求参数为map</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">convertMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">//分割字符串 "&amp;"</span></span><br><span class="line">		String[] keyValues= <span class="keyword">this</span>.queryStr.split(<span class="string">"&amp;"</span>);</span><br><span class="line">		<span class="keyword">for</span>(String keyValue:keyValues) &#123;</span><br><span class="line">			<span class="comment">//再次分割 "="</span></span><br><span class="line">			String[] kv=keyValue.split(<span class="string">"="</span>);</span><br><span class="line">			<span class="comment">//保证数组的长度为2</span></span><br><span class="line">			kv = Arrays.copyOf(kv, <span class="number">2</span>);</span><br><span class="line">			<span class="comment">//获取key和value</span></span><br><span class="line">			String key=kv[<span class="number">0</span>];</span><br><span class="line">			String value=kv[<span class="number">1</span>] == <span class="keyword">null</span>?<span class="keyword">null</span>:decode(kv[<span class="number">1</span>],<span class="string">"UTF-8"</span>);</span><br><span class="line">			<span class="comment">//存储到map中</span></span><br><span class="line">			<span class="keyword">if</span>(!parameterMap.containsKey(key)) &#123; <span class="comment">//表示第一次存储</span></span><br><span class="line">				parameterMap.put(key,<span class="keyword">new</span> ArrayList&lt;String&gt;());</span><br><span class="line">			&#125;</span><br><span class="line">			parameterMap.get(key).add(value);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 处理中文问题</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> String <span class="title">decode</span><span class="params">(String value,String enc)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> java.net.URLDecoder.decode(value,enc);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/***</span></span><br><span class="line"><span class="comment">	 * 通过name获取对应的表单的多个值</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> String[] getParameterValues(String key) &#123;</span><br><span class="line">		List&lt;String&gt; list=<span class="keyword">this</span>.parameterMap.get(key);</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">null</span> == list || list.size()&lt;<span class="number">1</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//将list转化为String[]</span></span><br><span class="line">		<span class="keyword">return</span> list.toArray(<span class="keyword">new</span> String[<span class="number">0</span>]);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/***</span></span><br><span class="line"><span class="comment">	 * 通过name获取对应的表单的一个值</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getParameter</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">		String[] values=getParameterValues(key);</span><br><span class="line">		<span class="keyword">return</span> values == <span class="keyword">null</span>?<span class="keyword">null</span>:values[<span class="number">0</span>];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//获取请求方式</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> method;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//获取请求路径</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> url;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//获取请求参数</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getQueryStr</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> queryStr;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhuchuli.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStreamWriter;</span><br><span class="line"><span class="keyword">import</span> java.net.ServerSocket;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 目标：将获取的请求参数转化为Map</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 朱楚利</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server05</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> ServerSocket serverSocket;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		Server05 server=<span class="keyword">new</span> Server05();</span><br><span class="line">		server.start(); </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//启动服务</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			serverSocket=<span class="keyword">new</span> ServerSocket(<span class="number">8888</span>);</span><br><span class="line">			receive();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			System.out.println(<span class="string">"服务器启动失败..."</span>);</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//接收连接处理</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Socket client = serverSocket.accept();</span><br><span class="line">			System.out.println(<span class="string">"一个客户端建立了连接...."</span>);</span><br><span class="line">			<span class="comment">//获取请求协议</span></span><br><span class="line">			Request02 request=<span class="keyword">new</span> Request02(client);</span><br><span class="line">			<span class="comment">//获取响应协议</span></span><br><span class="line">			Response response=<span class="keyword">new</span> Response(client);</span><br><span class="line">			<span class="comment">//只关注了内容</span></span><br><span class="line">			response.print(<span class="string">"&lt;html&gt;"</span>);</span><br><span class="line">			response.print(<span class="string">"&lt;head&gt;"</span>);</span><br><span class="line">			response.print(<span class="string">"&lt;title&gt;"</span>);</span><br><span class="line">			response.print(<span class="string">"服务器响应成功"</span>);</span><br><span class="line">			response.print(<span class="string">"&lt;/title&gt;"</span>);</span><br><span class="line">			response.print(<span class="string">"&lt;/head&gt;"</span>);</span><br><span class="line">			response.print(<span class="string">"&lt;body&gt;"</span>);</span><br><span class="line">			response.print(<span class="string">"zhuchuli Server回来了..."</span>+request.getParameter(<span class="string">"uname"</span>));</span><br><span class="line">			response.print(<span class="string">"&lt;/body&gt;"</span>);</span><br><span class="line">			response.print(<span class="string">"&lt;/html&gt;"</span>);</span><br><span class="line">		</span><br><span class="line">			<span class="comment">//只关注了状态码</span></span><br><span class="line">			response.pushToBrower(<span class="number">200</span>);</span><br><span class="line">			</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			System.out.println(<span class="string">"客户端连接出现错误..."</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//停止服务</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>引入Servlet<blockquote>
<ul>
<li>将业务代码解耦到对应的业务类中（具体的Servlet）</li>
<li>例子：Request与Response与上面雷同。</li>
</ul>
</blockquote>
</li>
</ul>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhuchuli.server;</span><br><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 服务器小脚本接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 朱楚利</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Servlet</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">service</span><span class="params">(Request request,Response response)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhuchuli.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RegisterServlet</span> <span class="keyword">implements</span> <span class="title">Servlet</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(Request request,Response response)</span> </span>&#123;</span><br><span class="line">		response.print(<span class="string">"&lt;html&gt;"</span>);</span><br><span class="line">		response.print(<span class="string">"&lt;head&gt;"</span>);</span><br><span class="line">		response.print(<span class="string">"&lt;title&gt;"</span>);</span><br><span class="line">		response.print(<span class="string">"第一个Servlet"</span>);</span><br><span class="line">		response.print(<span class="string">"&lt;/title&gt;"</span>);</span><br><span class="line">		response.print(<span class="string">"&lt;/head&gt;"</span>);</span><br><span class="line">		response.print(<span class="string">"&lt;body&gt;"</span>);</span><br><span class="line">		response.print(<span class="string">"注册成功："</span>+request.getParameter(<span class="string">"uname"</span>));</span><br><span class="line">		response.print(<span class="string">"&lt;/body&gt;"</span>);</span><br><span class="line">		response.print(<span class="string">"&lt;/html&gt;"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhuchuli.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginServlet</span> <span class="keyword">implements</span> <span class="title">Servlet</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(Request request,Response response)</span> </span>&#123;</span><br><span class="line">		response.print(<span class="string">"&lt;html&gt;"</span>);</span><br><span class="line">		response.print(<span class="string">"&lt;head&gt;"</span>);</span><br><span class="line">		response.print(<span class="string">"&lt;title&gt;"</span>);</span><br><span class="line">		response.print(<span class="string">"第一个Servlet"</span>);</span><br><span class="line">		response.print(<span class="string">"&lt;/title&gt;"</span>);</span><br><span class="line">		response.print(<span class="string">"&lt;/head&gt;"</span>);</span><br><span class="line">		response.print(<span class="string">"&lt;body&gt;"</span>);</span><br><span class="line">		response.print(<span class="string">"欢迎回来："</span>+request.getParameter(<span class="string">"uname"</span>));</span><br><span class="line">		response.print(<span class="string">"&lt;/body&gt;"</span>);</span><br><span class="line">		response.print(<span class="string">"&lt;/html&gt;"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhuchuli.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStreamWriter;</span><br><span class="line"><span class="keyword">import</span> java.net.ServerSocket;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 目标：加入Servlet，解耦了业务代码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 朱楚利</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server06</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> ServerSocket serverSocket;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		Server06 server=<span class="keyword">new</span> Server06();</span><br><span class="line">		server.start(); </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//启动服务</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			serverSocket=<span class="keyword">new</span> ServerSocket(<span class="number">8888</span>);</span><br><span class="line">			receive();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			System.out.println(<span class="string">"服务器启动失败..."</span>);</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//接收连接处理</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Socket client = serverSocket.accept();</span><br><span class="line">			System.out.println(<span class="string">"一个客户端建立了连接...."</span>);</span><br><span class="line">			<span class="comment">//获取请求协议</span></span><br><span class="line">			Request request=<span class="keyword">new</span> Request(client);</span><br><span class="line">			<span class="comment">//获取响应协议</span></span><br><span class="line">			Response response=<span class="keyword">new</span> Response(client);</span><br><span class="line">			<span class="comment">//只关注了内容</span></span><br><span class="line">			<span class="keyword">if</span>(request.getUrl().equals(<span class="string">"login"</span>)) &#123;</span><br><span class="line">				Servlet servlet=<span class="keyword">new</span> LoginServlet();</span><br><span class="line">				servlet.service(request, response);</span><br><span class="line">			&#125;<span class="keyword">else</span> <span class="keyword">if</span>(request.getUrl().equals(<span class="string">"reg"</span>))&#123;</span><br><span class="line">				Servlet servlet=<span class="keyword">new</span> RegisterServlet();</span><br><span class="line">				servlet.service(request, response);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//只关注了状态码</span></span><br><span class="line">			response.pushToBrower(<span class="number">200</span>);</span><br><span class="line">			</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			System.out.println(<span class="string">"客户端连接出现错误..."</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//停止服务</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>整合web.xml<blockquote>
<ul>
<li>根据配置文件动态的读取类名，再进行反射获取具体的Servlet来处理业务，真正的以不变应万变。</li>
<li>例子：Request类、Response类、Servlet接口、LoginServlet类、RegisterServlet类与上面雷同；web.xml配置文件暂时存放在src下</li>
</ul>
</blockquote>
</li>
</ul>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhuchuli.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStreamWriter;</span><br><span class="line"><span class="keyword">import</span> java.net.ServerSocket;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 目标：整合配置文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 朱楚利</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server07</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> ServerSocket serverSocket;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		Server07 server=<span class="keyword">new</span> Server07();</span><br><span class="line">		server.start(); </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//启动服务</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			serverSocket=<span class="keyword">new</span> ServerSocket(<span class="number">8888</span>);</span><br><span class="line">			receive();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			System.out.println(<span class="string">"服务器启动失败..."</span>);</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//接收连接处理</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Socket client = serverSocket.accept();</span><br><span class="line">			System.out.println(<span class="string">"一个客户端建立了连接...."</span>);</span><br><span class="line">			<span class="comment">//获取请求协议</span></span><br><span class="line">			Request request=<span class="keyword">new</span> Request(client);</span><br><span class="line">			<span class="comment">//获取响应协议</span></span><br><span class="line">			Response response=<span class="keyword">new</span> Response(client);</span><br><span class="line">			<span class="comment">//只关注了内容</span></span><br><span class="line">			Servlet servlet=WebApp.getServletFromUrl(request.getUrl());</span><br><span class="line">			System.out.println(servlet+<span class="string">"---&gt;"</span>+servlet);</span><br><span class="line">			<span class="keyword">if</span>(<span class="keyword">null</span>!=servlet) &#123;</span><br><span class="line">				servlet.service(request, response);</span><br><span class="line">				<span class="comment">//只关注了状态码</span></span><br><span class="line">				response.pushToBrower(<span class="number">200</span>);</span><br><span class="line">			&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">//错误...</span></span><br><span class="line">				response.pushToBrower(<span class="number">404</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			System.out.println(<span class="string">"客户端连接出现错误..."</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//停止服务</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhuchuli.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.SAXParser;</span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.SAXParserFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.xml.sax.Attributes;</span><br><span class="line"><span class="keyword">import</span> org.xml.sax.SAXException;</span><br><span class="line"><span class="keyword">import</span> org.xml.sax.helpers.DefaultHandler;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 解析配置文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 朱楚利</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebApp</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> WebContext webContext;</span><br><span class="line">	<span class="keyword">static</span> &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">//SAX解析</span></span><br><span class="line">			<span class="comment">//1.获取解析工厂</span></span><br><span class="line">			SAXParserFactory factory = SAXParserFactory.newInstance();</span><br><span class="line">			<span class="comment">//2.从解析工厂获取解析器</span></span><br><span class="line">			SAXParser parser = factory.newSAXParser();</span><br><span class="line">			<span class="comment">//3.编写处理器</span></span><br><span class="line">			<span class="comment">//4.加载文档document注册处理器</span></span><br><span class="line">			WebHandler handler = <span class="keyword">new</span> WebHandler();</span><br><span class="line">	        <span class="comment">//5、解析</span></span><br><span class="line">	        parser.parse(Thread.currentThread().getContextClassLoader().getResourceAsStream(<span class="string">"web.xml"</span>), handler);</span><br><span class="line">	        <span class="comment">//分析和处理数据</span></span><br><span class="line">	        webContext=<span class="keyword">new</span> WebContext(handler.getEntitys(), handler.getMappings());</span><br><span class="line">		&#125;<span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">			System.out.println(<span class="string">"解析配置文件错误"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/***</span></span><br><span class="line"><span class="comment">	 * 通过url获取配置文件对应的Servlet</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> url</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Servlet <span class="title">getServletFromUrl</span><span class="params">(String url)</span> </span>&#123;</span><br><span class="line">		String className = webContext.getClz(<span class="string">"/"</span> +  url);</span><br><span class="line">        Class clz;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			clz = Class.forName(className);</span><br><span class="line">			Servlet servlet=(Servlet) clz.getConstructor().newInstance();</span><br><span class="line">			<span class="keyword">return</span> servlet;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			<span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhuchuli.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.xml.sax.Attributes;</span><br><span class="line"><span class="keyword">import</span> org.xml.sax.SAXException;</span><br><span class="line"><span class="keyword">import</span> org.xml.sax.helpers.DefaultHandler;</span><br><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 处理器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 朱楚利</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebHandler</span> <span class="keyword">extends</span> <span class="title">DefaultHandler</span></span>&#123;</span><br><span class="line">	<span class="comment">//定义容器 用于存储用户</span></span><br><span class="line">	<span class="keyword">private</span> List&lt;Entity&gt; entitys;</span><br><span class="line">	<span class="keyword">private</span> List&lt;Mapping&gt; mappings;</span><br><span class="line">	<span class="keyword">private</span> Entity enity;</span><br><span class="line">	<span class="keyword">private</span> Mapping mapping;</span><br><span class="line">	<span class="comment">//存储当前操作的标签名</span></span><br><span class="line">	<span class="keyword">private</span> String tag;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> isMapping = <span class="keyword">false</span>;<span class="comment">//标志操作哪个标签</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startDocument</span><span class="params">()</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line">		entitys=<span class="keyword">new</span> ArrayList&lt;Entity&gt;();</span><br><span class="line">		mappings=<span class="keyword">new</span> ArrayList&lt;Mapping&gt;();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//解析元素 标签</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startElement</span><span class="params">(String uri, String localName, String qName, Attributes attributes)</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">null</span>!=qName) &#123;</span><br><span class="line">			tag=qName;<span class="comment">//存储当前操作的标签名</span></span><br><span class="line">			<span class="keyword">if</span>(tag.equals(<span class="string">"servlet"</span>)) &#123;</span><br><span class="line">				enity=<span class="keyword">new</span> Entity();</span><br><span class="line">				isMapping = <span class="keyword">false</span>;</span><br><span class="line">			&#125;<span class="keyword">else</span> <span class="keyword">if</span>(tag.equals(<span class="string">"servlet-mapping"</span>)) &#123;</span><br><span class="line">				mapping=<span class="keyword">new</span> Mapping();</span><br><span class="line">				isMapping = <span class="keyword">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//标签内容</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">characters</span><span class="params">(<span class="keyword">char</span>[] ch, <span class="keyword">int</span> start, <span class="keyword">int</span> length)</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line">		String contents=<span class="keyword">new</span> String(ch,start,length).trim();</span><br><span class="line">		<span class="comment">//trim()方法 去掉前后空格</span></span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">null</span> != tag) &#123;</span><br><span class="line">			<span class="keyword">if</span>(isMapping) &#123; <span class="comment">// 操作servlet-mapping</span></span><br><span class="line">				<span class="keyword">if</span>(tag.equals(<span class="string">"servlet-name"</span>)) &#123;</span><br><span class="line">					mapping.setName(contents);</span><br><span class="line">				&#125;<span class="keyword">else</span> <span class="keyword">if</span>(tag.equals(<span class="string">"url-pattern"</span>)) &#123;</span><br><span class="line">					mapping.addPatterns(contents);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">if</span>(tag.equals(<span class="string">"servlet-name"</span>)) &#123;</span><br><span class="line">					enity.setName(contents);</span><br><span class="line">				&#125;<span class="keyword">else</span> <span class="keyword">if</span>(tag.equals(<span class="string">"servlet-class"</span>)) &#123;</span><br><span class="line">					enity.setClz(contents);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endElement</span><span class="params">(String uri, String localName, String qName)</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">null</span>!=qName) &#123;</span><br><span class="line">			<span class="keyword">if</span>(qName.equals(<span class="string">"servlet"</span>)) &#123;</span><br><span class="line">				entitys.add(enity);</span><br><span class="line">			&#125;<span class="keyword">else</span> <span class="keyword">if</span>(qName.equals(<span class="string">"servlet-mapping"</span>)) &#123;</span><br><span class="line">				mappings.add(mapping);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		tag=<span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endDocument</span><span class="params">()</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;Entity&gt; <span class="title">getEntitys</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> entitys;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;Mapping&gt; <span class="title">getMappings</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> mappings;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhuchuli.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * servlet-mapping</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 朱楚利</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Mapping</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	<span class="keyword">private</span> Set&lt;String&gt; patterns;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Mapping</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		patterns = <span class="keyword">new</span> HashSet&lt;String&gt;();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> name;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.name = name;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getPatterns</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> patterns;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPatterns</span><span class="params">(Set&lt;String&gt; patterns)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.patterns = patterns;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addPatterns</span><span class="params">(String pattern)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.patterns.add(pattern);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhuchuli.server;</span><br><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * servlet</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 朱楚利</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Entity</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	<span class="keyword">private</span> String clz;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Entity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> name;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.name = name;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getClz</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> clz;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setClz</span><span class="params">(String clz)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.clz = clz;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>login<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.zhuchuli.server.LoginServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>login<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/login<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/g<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>reg<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.zhuchuli.server.RegisterServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>reg<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/reg<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/r<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>高效分发器<blockquote>
<ul>
<li>加入了多线程，可以同时处理多个请求，使用的是短链接。</li>
</ul>
</blockquote>
</li>
</ul>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhuchuli.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 分发器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 朱楚利</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Dispatcher</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> Socket client;</span><br><span class="line">	<span class="keyword">private</span> Request request;</span><br><span class="line">	<span class="keyword">private</span> Response response;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Dispatcher</span><span class="params">(Socket client)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.client=client;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">//获取请求协议</span></span><br><span class="line">			request=<span class="keyword">new</span> Request(client);</span><br><span class="line">			<span class="comment">//获取响应协议</span></span><br><span class="line">			response=<span class="keyword">new</span> Response(client);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			<span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">			e.printStackTrace();</span><br><span class="line">			<span class="keyword">this</span>.release();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Servlet servlet=WebApp.getServletFromUrl(request.getUrl());</span><br><span class="line">			<span class="keyword">if</span>(<span class="keyword">null</span>!=servlet) &#123;</span><br><span class="line">				servlet.service(request, response);</span><br><span class="line">				<span class="comment">//只关注了状态码</span></span><br><span class="line">				response.pushToBrower(<span class="number">200</span>);</span><br><span class="line">			&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">//错误...</span></span><br><span class="line">				response.pushToBrower(<span class="number">404</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;<span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">			<span class="comment">//错误...</span></span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				response.pushToBrower(<span class="number">505</span>);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e1) &#123;</span><br><span class="line">				<span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">				e1.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		release();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//释放资源</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">release</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			client.close();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e1) &#123;</span><br><span class="line">			<span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">			e1.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhuchuli.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStreamWriter;</span><br><span class="line"><span class="keyword">import</span> java.net.ServerSocket;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 目标：多线程处理加入分发器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 朱楚利</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server08</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> ServerSocket serverSocket;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> isRunning;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		Server08 server=<span class="keyword">new</span> Server08();</span><br><span class="line">		server.start(); </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//启动服务</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			serverSocket=<span class="keyword">new</span> ServerSocket(<span class="number">8888</span>);</span><br><span class="line">			isRunning = <span class="keyword">true</span>;</span><br><span class="line">			receive();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			System.out.println(<span class="string">"服务器启动失败..."</span>);</span><br><span class="line">			stop();</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//接收连接处理</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">while</span>(isRunning) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Socket client = serverSocket.accept();</span><br><span class="line">				System.out.println(<span class="string">"一个客户端建立了连接...."</span>);</span><br><span class="line">				<span class="keyword">new</span> Thread(<span class="keyword">new</span> Dispatcher(client)).start();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">				System.out.println(<span class="string">"客户端连接出现错误..."</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//停止服务</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		isRunning=<span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">this</span>.serverSocket.close();</span><br><span class="line">			System.out.println(<span class="string">"服务器已经停止"</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			<span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>经典404以及首页处理<blockquote>
<ul>
<li>读取错误页面和首页内容即可。</li>
</ul>
</blockquote>
</li>
</ul>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhuchuli.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 分发器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 朱楚利</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Dispatcher2</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> Socket client;</span><br><span class="line">	<span class="keyword">private</span> Request request;</span><br><span class="line">	<span class="keyword">private</span> Response response;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Dispatcher2</span><span class="params">(Socket client)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.client=client;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">//获取请求协议</span></span><br><span class="line">			request=<span class="keyword">new</span> Request(client);</span><br><span class="line">			<span class="comment">//获取响应协议</span></span><br><span class="line">			response=<span class="keyword">new</span> Response(client);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			<span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">			e.printStackTrace();</span><br><span class="line">			<span class="keyword">this</span>.release();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="keyword">null</span>==request.getUrl() || request.getUrl().equals(<span class="string">""</span>)) &#123;</span><br><span class="line">				<span class="comment">//错误...</span></span><br><span class="line">				<span class="comment">//类加载器</span></span><br><span class="line">				InputStream is=Thread.currentThread().getContextClassLoader().getResourceAsStream(<span class="string">"index.html"</span>);</span><br><span class="line">				response.print(<span class="keyword">new</span> String(is.readAllBytes(),<span class="string">"utf-8"</span>));</span><br><span class="line">				response.pushToBrower(<span class="number">200</span>);</span><br><span class="line">				is.close();</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			Servlet servlet=WebApp.getServletFromUrl(request.getUrl());</span><br><span class="line">			<span class="keyword">if</span>(<span class="keyword">null</span>!=servlet) &#123;</span><br><span class="line">				servlet.service(request, response);</span><br><span class="line">				<span class="comment">//只关注了状态码</span></span><br><span class="line">				response.pushToBrower(<span class="number">200</span>);</span><br><span class="line">			&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">//错误...</span></span><br><span class="line">				<span class="comment">//类加载器</span></span><br><span class="line">				InputStream is=Thread.currentThread().getContextClassLoader().getResourceAsStream(<span class="string">"error.html"</span>);</span><br><span class="line">				response.print(<span class="keyword">new</span> String(is.readAllBytes(),<span class="string">"utf-8"</span>));</span><br><span class="line">				response.pushToBrower(<span class="number">404</span>);</span><br><span class="line">				is.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;<span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">			<span class="comment">//错误...</span></span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				response.pushToBrower(<span class="number">505</span>);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e1) &#123;</span><br><span class="line">				<span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">				e1.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		release();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//释放资源</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">release</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			client.close();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e1) &#123;</span><br><span class="line">			<span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">			e1.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>—&gt; 还差中文乱码有待解决 &lt;—-</p>
<h1 id="内容到这里暂时就结束了"><a href="#内容到这里暂时就结束了" class="headerlink" title="内容到这里暂时就结束了"></a>内容到这里暂时就结束了</h1></div><footer class="post-footer"><div class="post-footer-end"><span>------</span><span>本文结束，感谢您的阅读</span><span>------</span></div><div class="post-footer-copyright"><div class="copyright-author"><span class="copyright-name">本文作者:</span><span class="copyright-value"><a href="http://qqqqyy.github.io">chuli</a></span></div><div class="copyright-link"><span class="copyright-name">本文链接:</span><span class="copyright-value"><a href="http://qqqqyy.github.io/2019/08/16/手写Web服务器/">http://qqqqyy.github.io/2019/08/16/手写Web服务器/</a></span></div><div class="copyright-notice"><span class="copyright-name">版权声明:</span><span class="copyright-value">本博客所有文章除特别声明外，均采用  <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> 许可协议。转载请注明出处！</span></div></div><nav id="paginator"><div class="post-paginator"><div class="article-prev pull-left"><a href="/2019/08/29/多线程/"><i class="fa fa-chevron-left"></i><span class="title">多线程</span></a></div><div class="article-next pull-right"><a href="/2019/07/28/Struts2/"><span class="title">Struts2</span><i class="fa fa-chevron-right"></i></a></div></div></nav></footer></div></div></main><footer id="footer"><div class="footer-inner"><div><span>&copy; 2019</span><span class="fa fa-heart heart-beat footer-separator" style="color: #ff0000"></span><span>chuli.</span></div><div><span class="footer-powered">由 <a href="http://hexo.io/" title="hexo" target="_blank" rel="noopener">hexo</a> 强力驱动</span><span> v3.9.0.</span><span class="footer-separator">|</span><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="stun" target="_blank" rel="noopener">stun</a></span><span> v1.0.2.</span></div><div class="busuanzi"><script async src="https://cdn.jsdelivr.net/gh/sukkaw/busuanzi@2.3/bsz.pure.mini.js"></script><span class="busuanzi-uv"><i class="fa fa-user"></i><span>访问人数 </span><span id="busuanzi_value_site_uv"></span></span><span class="separator">|</span><span class="busuanzi-pv"><i class="fa fa-eye"></i><span>浏览总量 </span><span id="busuanzi_value_site_pv"></span></span></div></div></footer><div id="back-top"><div class="back-top-inner" title="回到顶部"><i class="fa fa-rocket"></i></div></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="/js/utils.js?v=1.0.2"></script><script src="/js/scroll.js?v=1.0.2"></script><script src="/js/header.js?v=1.0.2"></script><script src="/js/sidebar.js?v=1.0.2"></script><script src="/js/post.js?v=1.0.2"></script></body></html>